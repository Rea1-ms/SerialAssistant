# .gitlab-ci.yml

image: oven/bun:alpine

cache:
  key:
    files:
      - bun.lock
  paths:
    - node_modules/

pages:
  stage: deploy

  script:
    - echo "ğŸš€ Installing dependencies with Bun..."
    - bun install --frozen-lockfile
    - echo "ğŸ› ï¸ Building SerialAssistant site..."
    - bun run build
    - echo "âœ… Build complete! Moving 'dist' to 'public' for GitLab Pages..."
    - mv public public_backup || true  # å¤‡ä»½æ—§çš„ public ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    - mv dist public

  artifacts:
    paths:
      - public

  # --- è¿™æ˜¯çœŸæ­£æ»¡è¶³ä½ éœ€æ±‚çš„ rules ---
  rules:
    # è§„åˆ™ä¸€ï¼šå¦‚æœæäº¤åˆ°çš„æ˜¯é»˜è®¤ä¸»åˆ†æ”¯
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        ENVIRONMENT_NAME: "production"
        AUTO_STOP_IN: "never"
      when: on_success

    # è§„åˆ™äºŒï¼šå¦‚æœæäº¤åˆ°çš„ä¸æ˜¯é»˜è®¤ä¸»åˆ†æ”¯ï¼ˆå³å…¶ä»–æ‰€æœ‰åˆ†æ”¯ï¼‰
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      variables:
        ENVIRONMENT_NAME: "review/$CI_COMMIT_REF_NAME"
        AUTO_STOP_IN: "1 week"
      when: on_success

  environment:
    name: $ENVIRONMENT_NAME
    auto_stop_in: $AUTO_STOP_IN
    on_stop: stop_review

stop_review:
  stage: deploy
  script:
    - echo "Stopping review environment..."

  environment:
    name: $ENVIRONMENT_NAME
    action: stop

  rules:
    # ä¿æŒè¿™ä¸ªè§„åˆ™ï¼Œè®©åœæ­¢æŒ‰é’®åªå‡ºç°åœ¨åˆå¹¶è¯·æ±‚ä¸­
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual
